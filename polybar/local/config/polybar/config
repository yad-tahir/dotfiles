; Copyright (C) 2019

; This program is free software; you can redistribute it and/or
; modify it under the terms of the GNU General Public License
; as published by the Free Software Foundation; either version 2
; of the License, or (at your option) any later version.

; This program is distributed in the hope that it will be useful,
; but WITHOUT ANY WARRANTY; without even the implied warranty of
; MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
; GNU General Public License for more details.

; You should have received a copy of the GNU General Public License
; along with this program; if not, write to the Free Software
; Foundation, Inc., 51 Franklin Street, Fifth Floor, Boston, MA
; 02110-1301, USA.

[colors]
background = ${xrdb:background}
background-alt = ${xrdb:color15}
foreground = ${xrdb:foreground}
foreground-alt = ${xrdb:background}
primary = ${xrdb:color2}
secondary = ${xrdb:color10}
warning = ${xrdb:color9}
alert = ${xrdb:color11}

[bar/orange]
monitor = ${env:MONITOR}
width = 100%
height = ${xrdb:Panel.height}
offset-x = 0%
offset-y = 0%
radius = 0
fixed-center = true
background = ${colors.background}
foreground = ${colors.foreground}
line-size = 2
line-color = ${colors.foreground}
border-size = 0
border-color = ${colors.background}
padding-left = 1
padding-right = 1
module-margin-left = 0
module-margin-right = 0
;;		  <Font name>	:<properties>	; <vertical-offset>
font-0 = "DejaVu Sans Mono:style=regular:size=12:antialias=true;1"
font-1 = "DejaVu Sans Mono:weight=bold:size=12:antialias=true;1"
font-2 = "FontAwesome:size=12:antialias=true;1"
modules-left = bspwm xwindow
modules-center =
modules-right = music fan memory memory-zfs cpu-freq processes threads emacs dGPU portage-world portage-packages insync ping public-ip battery pulseaudio xkeyboard date
tray-position = right
tray-padding = 0
wm-restack = bspwm
;override-redirect = true
;scroll-up = bspwm-desknext
;scroll-down = bspwm-deskprev
; cursor-click = auto
; cursor-scroll = auto
enable-ipc = true

[settings]
; The throttle settings lets the eventloop swallow up til X events
; if they happen within Y millisecond after first event was received.
; This is done to prevent flood of update event.
;
; For example if 5 modules emit an update event at the same time, we really
; just care about the last one. But if we wait too long for events to swallow
; the bar would appear sluggish so we continue if timeout
; expires or limit is reached.
throttle-output = 5
throttle-output-for = 10

; Time in milliseconds that the input handler will wait between processing events
throttle-input-for = 30

; Reload upon receiving XCB_RANDR_SCREEN_CHANGE_NOTIFY events
screenchange-reload = false

; Compositing operators
; @see: https://www.cairographics.org/manual/cairo-cairo-t.html#cairo-operator-t
compositing-background = source
compositing-foreground = over
compositing-overline = over
compositing-underline = over
compositing-border = over

; Define fallback values used by all module formats
format-foreground =
format-background =
format-underline =
format-overline =
format-spacing =
format-padding =
format-margin =
format-offset =

; Enables pseudo-transparency for the bar
; If set to true the bar can be transparent without a compositor.
pseudo-transparency = false

[module/xwindow]
type = internal/xwindow
label = %title%
label-underline= ${colors.warning}

[module/xkeyboard]
type = internal/xkeyboard
blacklist-0 = num lock

format-prefix = " "
label-layout = %name%
label-indicator-padding = 1
label-indicator-margin = 0
label-indicator-background = ${colors.secondary}
label-indicator-foreground = ${colors.foreground-alt}

[module/bspwm]
type = internal/bspwm
format = "<label-monitor> <label-state> <label-mode> "
label-monitor = %name%
label-monitor-foreground = ${colors.warning}
label-focused = %name%
label-focused-background = ${colors.primary}
label-focused-underline= ${colors.primary}
label-focused-foreground= ${colors.foreground-alt}
label-focused-padding = 1
label-occupied = %name%
label-occupied-background = ${colors.background-alt}
label-occupied-foreground = ${colors.foreground}
label-occupied-padding = 1
label-urgent = %name%!
label-urgent-background = ${colors.warning}
label-urgent-padding = 1
label-empty = %name%
label-empty-foreground = ${colors.foreground}
label-empty-padding = 1
wrapping-scroll = false

; label-monocle = M
; label-tiled = T
; label-fullscreen = F
; label-floating = F
; label-pseudotiled = P
label-locked = L
label-locked-padding = 1
label-locked-foreground = ${colors.foreground-alt}
label-locked-background = ${colors.alert}
label-sticky = X
label-sticky-padding = 1
label-sticky-foreground = ${colors.foreground-alt}
label-sticky-background = ${colors.primary}
label-private = F
label-private-padding = 1
label-private-foreground = ${colors.foreground-alt}
label-private-background = ${colors.warning}
label-marked = M
label-marked-padding = 1
label-marked-foreground = ${colors.foreground-alt}
label-marked-background = ${colors.secondary}


[module/memory-zfs]
type = custom/script
label = "  %output:0:3:%GB"
exec =  cat /proc/spl/kstat/zfs/arcstats | awk '/^size[[:space:]]/{print $3/(1024^3)}' | bc
interval = 30

[module/memory]
type = custom/script
label = " %output:0:4:%GB"
exec =  free | awk '/^Mem/{print $3/(1024^2)}' | bc
interval = 30

[module/cpu]
type = internal/cpu
interval = 10
format = <label>
label = CPU %percentage%%
ramp-load-spacing = 1

[module/cpu-freq]
type = custom/script
label = "  %output%GHz"
;; Get the average frequency from /proc/cpuinfo
exec = cat /proc/cpuinfo | awk '/MHz/{n+=1; s+=$4} END{printf "%.1f\n", s/n/1000}'
;; To reduce false readings, use an odd interval to offset from other polybar modules
interval = 8

[module/processes]
type = custom/script
label =  %output%
exec = ps axl | awk '$7 != 0 && $10 !~ "Z"'| wc -l
interval = 10
label-padding = 1

[module/threads]
type = custom/script
label =  %output%
exec = ps axl -L | awk '$7 != 0 && $10 !~ "Z"'| wc -l
interval = 10
label-padding = 0

[module/emacs]
type = custom/ipc
format-prefix = "  "
hook-0 = emacsclient -e '(length (do-list-buffers))'
initial = 1
label-padding = 1

[module/portage-world]
type = custom/ipc
format-prefix = " |  "
hook-0 = cat /var/lib/portage/world | wc -l
;; Sleep is required to make sure portage's db is up-to-date
hook-1 = sleep 1 && cat /var/lib/portage/world | wc -l
initial = 1
label-padding = 1

[module/portage-packages]
type = custom/ipc
format-prefix = "  "
hook-0 = qlist -I | wc -l
;; Sleep is required to make sure portage's db is up-to-date
hook-1 = sleep 1 && qlist -I | wc -l
initial = 1
label-padding = 0

[module/insync]
type = custom/script
label =" | %output%"
exec = ~/.config/polybar/blocks/insync.sh
interval = 60

[module/ping]
type = custom/script
label =" %output%"
exec = ping 8.8.8.8 -c 3 2>&1 | awk '/avg/{split($4,arr,"/"); printf("%3.0fms\n",arr[2])};/connect/{print "%{F'$(xrdb -query | awk '/\*color9:/{print $2}')'}NO-PING%{F-}"}' | awk '$1=$1'
interval = 60

[module/public-ip]
type = custom/ipc
format-prefix = " "
hook-0 = curl ipinfo.io 2>&1 | awk '/country/{print " " substr($2,2,2)}/^curl/{print "%{F'$(xrdb -query | awk '/\*color9:/{print $2}')'} NO-NET%{F-}"}'
initial = 1

[module/music]
type = custom/ipc
label = %output%
format-underline= ${colors.secondary}
hook-0 = echo
hook-1 = ~/.config/polybar/blocks/music.sh
initial = 1
label-padding = 1

[module/date]
type = internal/date
interval = 1
time = %A, %B %d %H:%M:%S
time-alt =
; format-prefix =
format-prefix-foreground = ${colors.foreground-alt}
format-underline =
label = %time%

[module/pulseaudio]
type = internal/pulseaudio
format-volume = <label-volume>
label-volume =   %percentage%%
label-muted =  muted
label-muted-foreground = ${colors.alert}
bar-volume-width = 1
bar-volume-gradient = false
bar-volume-indicator =
bar-volume-indicator-font = 2
bar-volume-fill = ─
bar-volume-fill-font = 2
bar-volume-empty = ─
bar-volume-empty-font = 2
bar-volume-empty-foreground = ${colors.alert}

[module/dGPU]
format-prefix = " "
type = custom/ipc
hook-0 = ~/.config/polybar/blocks/dGPU.sh
initial = 1
label-padding = 0

[module/battery]
type = internal/battery
battery = BAT0
adapter = AC
full-at = 98
time-format = %H:%M
format-full-prefix = "| "
format-charing-prefix = "| "
format-discharing-prefix = "| "
format-charging = <label-charging>
format-discharging = <label-discharging>
label-charging =  %percentage%% %time% %consumption%mW
label-charging-foreground = ${colors.primary}
label-discharging =  %percentage%% %time% %consumption%mW
label-discharging-foreground = ${colors.warning}
label-full =  %percentage%%
format-full-padding = 1
format-charging-padding = 1
format-discharging-padding = 1

[module/fan]
type = custom/script
label =  %output%
exec = sensors | awk '/^fan1/{print $2}/^fan2/{print $2}' | tr '\n' ' '
interval = 10
label-padding = 0

[global/wm]
margin-top = 0
margin-bottom = 0
